@using Telerik.DataSource;
@using Telerik.DataSource.Extensions

<TelerikGrid @ref="@GridRef"
             Data="Generators"
             Sortable="true"
             SortMode="@SortMode.Multiple"
             FilterMode="GridFilterMode.FilterMenu"
             Resizable="true"
             Reorderable="true"
             Height="600px" 
             PageSize="25"
             RowHeight="60"
             ScrollMode="@GridScrollMode.Virtual"
             OnRowRender="@OnRowRender" 
             OnStateInit="@((GridStateEventArgs<ModtblGenerator> args) => OnStateInitHandler(args))"
>
   
    @*  **************************************** Tool Bar **************************************** *@
    <GridToolBarTemplate>

        @* ******** Excel Button *@
        <GridCommandButton Command="ExcelExport" Icon="@SvgIcon.FileExcel">Export to Excel</GridCommandButton>

        @* ******** Clear All Button *@
        <TelerikButton ThemeColor="primary" OnClick="@ClearGridFilter">Clear Filters & Sorts</TelerikButton>

        @* ******** Record Count *@
        <span class="ml-2">Records: @Generators.Count</span>

    </GridToolBarTemplate>

    <GridExport>
        <GridExcelExport FileName="@strExcelFileName" AllPages="true"
                         OnBeforeExport="@(()=> { strExcelFileName=CreateExcelFileName(); } )" />
    </GridExport>

    @*  **************************************** Columns **************************************** *@

    <GridColumns>
        @* Gen Number is a HyperLink to the Generator Details Page *@
        <GridColumn Field="@nameof(ModtblGenerator.GenName)" Title="Generator Name" HeaderClass="header" />
        <GridColumn Field="@nameof(ModtblGenerator.GenNum)" Title="Gen Number" HeaderClass="header" />
        <GridColumn Field="@nameof(ModtblGenerator.Street)" Title="Street" HeaderClass="header" />
        <GridColumn Field="@nameof(ModtblGenerator.City)" Title="City" HeaderClass="header" />
        <GridColumn Field="@nameof(ModtblGenerator.Province)" Title="Province" HeaderClass="header" />
        <GridColumn Field="@nameof(ModtblGenerator.WasteClasses)" Title="Waste Classes" HeaderClass="header" Filterable="false"/>

    </GridColumns>
</TelerikGrid>

<TelerikWindow @bind-Visible="@blnShowWindowWasteClasses" Modal="true">
    <WindowTitle>
        <strong>@currentGenerator.GenName</strong>
    </WindowTitle>
    <WindowContent>
        @currentGenerator.WasteClasses
    </WindowContent>
    <WindowActions>
        <WindowAction Name="Close"></WindowAction>
    </WindowActions>
</TelerikWindow>


@code {

    [Parameter]
    public List<ModtblGenerator> Generators { get; set; }

    [Parameter]
    public string FirstChars { get; set; }

    private ModtblGenerator currentGenerator = new ModtblGenerator();

    private TelerikGrid<ModtblGenerator> GridRef { get; set; }

    private bool blnShowWindowWasteClasses = false;

    private string strExcelFileName = "excelfile";

    //**************************** Methods *************************************

    private void OnRowDoubleClickHandler(GridRowClickEventArgs args)
    {
        currentGenerator = args.Item as ModtblGenerator;

        blnShowWindowWasteClasses = !blnShowWindowWasteClasses;
    }

    string CreateExcelFileName()
    {
        return $"GeneratorSearch_{FirstChars}_{DateTime.Now.ToString("MMMM_dd_yyyy")}";
    }

    private async Task AutoFitAllColumns()
    {
        if (GridRef != null)
        {
            await GridRef.AutoFitAllColumnsAsync();
        }
    }

    private async Task ClearGridFilter()
    {
        GridState<ModtblGenerator> desiredState = new GridState<ModtblGenerator>()
            {
                //clears the filter list in the new Grid state
                FilterDescriptors = new List<IFilterDescriptor>()
            };

        await GridRef.SetStateAsync(desiredState);
    }

    private async Task OnGridRead(GridReadEventArgs args)
    {
        await Task.Delay(100); // simulate async operation
        DataSourceResult result = Generators.ToDataSourceResult(args.Request);

        args.Data = result.Data;
        args.Total = result.Total;
        args.AggregateResults = result.AggregateResults;

    }

    // **************************** Grid Styling ****************************

    // apply ellipsis to all columns
    private void OnRowRender(GridRowRenderEventArgs args)
    {
        args.Class = "custom-ellipsis";
    }

    async Task OnStateInitHandler(GridStateEventArgs<ModtblGenerator> args)
    {
        var state = new GridState<ModtblGenerator>
        {
                SortDescriptors = new List<SortDescriptor>
            {
                new SortDescriptor{ Member = "GenName", SortDirection = ListSortDirection.Ascending }
            }
        };

        args.GridState = state;
    }

}

<style>
    .header {
        font-weight: bold;
        color: black;
    }
    /* OnRowRender */
    .k-grid tr.custom-ellipsis .k-table-td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>